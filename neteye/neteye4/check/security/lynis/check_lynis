#!/bin/bash
# check_lynis
# Version: 0.2
# 08.08.2019  Simone Cagol, Italy
# Thanks to contributors:
# - Massimo Giaimo
#---------------------------------------------------
# this plugin check the log $path generated by lynis
# /usr/local/lynis/lynis audit system --quick
#---------------------------------------------------



healthWarningStatus=0
healthCriticalStatus=0
healthUnknownStatus=0
healthNOTStatus=0
healthString=""

W=70
C=60

usage()
{
  echo "usage: ./check_lynis -W 80 -C 70"
  exit 3
}

while getopts :W:C: OPTNAME; do
        case "$OPTNAME" in
            W)  W="$OPTARG";;
            C)  C="$OPTARG";;
            *)  usage;;
        esac
done


if [ $C -ge $W ]; then
    echo "The warning must be higher than the critical"
    echo "Warning: $W"
    echo "Critical: $C"
    echo ""
    echo "For more information:  ./${0##*/} --help"
    exit 1
fi

path="/var/log/lynis.log"


if [ ! -f $path ]; then
    healthString="File $path not found!"
    healthUnknownStatus=1
else
    line=$(more $path | grep "Hardening index")
    warning=$(more $path | grep "Warning: ")

    if [ "$line" = "" ]; then
        healthString="Hardening index not found in $path!"
        healthUnknownStatus=1
    else
        date=$(echo $line |awk '{print $1 " " $2}' | xargs)
        index=$(echo $line |awk '{print $6}'| cut -d "[" -f2| cut -d "]" -f1 | xargs)
        healthString="Hardening index : $index ($date)\n$warning| HardeningIndex=$index;$W;$C;0;100"

        if [ $index -le $W ]; then
            if [ $index -le $C ]; then
                healthCriticalStatus=1
            else
                healthWarningStatus=1
            fi
        fi


    fi
fi




if [ "$healthNOTStatus" = "1" ] ; then
echo -e "$healthString"
exit 0
fi
if [ "$healthUnknownStatus" = "1" ] ; then
echo -e "Unknown - $healthString"
exit 3
fi
if [ "$healthCriticalStatus" = "1" ] ; then
echo -e "CRITICAL - $healthString"
exit 2
fi
if [ "$healthWarningStatus" = "1" ] ; then
echo -e "WARNING - $healthString"
exit 1
fi
if [ "$healthCriticalStatus" = "0" ] && [ "$healthWarningStatus" = "0" ] ; then
echo -e "OK - $healthString"
exit 0
fi